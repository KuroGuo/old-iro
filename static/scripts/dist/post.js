define(["app","vue","superagent","socket.io"],function(e,t,n,o){"use strict";var i=o(),s=new t({el:article,data:function(){var e=document.querySelector("#article");return{id:parseFloat(e.dataset.id),likes:parseFloat(e.dataset.likes)||0,unlikes:parseFloat(e.dataset.unlikes)||0}},methods:{like:function(){var e=this;n.post("/p/like",{id:e.id},function(t,n){if((t||200!==n.status)&&(e.likes--,t))throw t}),e.likes++},unlike:function(){var e=this;n.post("/p/unlike",{id:e.id},function(e,t){if((e||200!==t.status)&&(this.unlikes--,e))throw e}),e.unlikes++}}}),m=new t({el:"#comments",data:{comments:[],commentsInfo:{},pagesize:15,currentPage:1,joined:!1,pagerMode:"simple",socketioHandlers:{comment:{sendEnd:function(e){var t,n=e.err,o=e.body.tempId,i=e.body.comment,s=this;for(t=0;t<s.comments.length&&s.comments[t].tempId!==o;t++);if(n)throw i=s.comments[0],i.err=n,s.comments.$set(t,i),n;var m=c.$el.querySelector(".textarea-content");m.innerHTML=c.content="",s.comments.$set(t,i)},joinend:function(){this.joined=!0},receive:function(e){var t=e.body.comment;this.insertComment(t)}}}},computed:{simplePageButtons:function(){var e=[],t=this.currentPage-2,n=this.currentPage+2;this.currentPage<=3?t=1:this.currentPage>=this.commentsInfo.pages-2&&(n=this.commentsInfo.pages),t>1&&e.push({text:"首",value:1});for(var o=t;t+4>=o;o++)if(!(1>o)){if(o>this.commentsInfo.pages)break;e.push({text:o,value:o})}return t+4<this.commentsInfo.pages&&e.push({text:"尾",value:this.commentsInfo.pages}),e},fullPageButtons:function(){for(var e=[],t=1;t<=this.commentsInfo.pages;t++)e.push({text:t,value:t});return e}},events:{"hook:created":function(){var e=this;e.loadCommentsInfo(function(){e.commentsInfo.pages>0&&e.loadComments()}),i.on("comment",function(t){e.socketioHandlers.comment[t.method].call(e,t)}),i.emit("comment",{method:"join",body:{postId:s.id}})}},methods:{loadCommentsInfo:function(e){var t=this;n.get("/p/comments/"+s.id,{pagesize:t.pagesize},function(n,o){if(n)throw n;t.commentsInfo=o.body,"function"==typeof e&&e()})},loadComments:function(e,t){var o=this;e=e||1,n.get("/p/comments/"+s.id+"/"+e,{pagesize:o.pagesize},function(n,i){if(n)throw n;o.comments=i.body,o.currentPage=e,"function"==typeof t&&t()})},insertComment:function(e){this.comments.unshift(e),this.comments.length>this.pagesize&&(this.comments.pop(),this.commentsInfo.count++,this.commentsInfo.pages=Math.ceil(this.commentsInfo.count/this.pagesize))},gotoPage:function(e,t){var n=this;"function"==typeof e&&(t=e,e=null),n.loadComments(e,function(){window.scrollBy(0,n.$el.parentNode.getBoundingClientRect().top),"function"==typeof t&&t()}),n.loadCommentsInfo()},togglePagerMode:function(){this.pagerMode="simple"===this.pagerMode?"full":"simple"}}}),c=new t({el:"#form_comment_wrapper",data:{postId:0,content:""},computed:{currentPage:function(){return m.currentPage},joined:function(){return m.joined}},methods:{onkeydown:function(e){if(13===e.keyCode&&!e.target.innerHTML)return e.preventDefault();if(e.ctrlKey&&13===e.keyCode){var t=document.createEvent("HTMLEvents");t.initEvent("submit",!1,!0),this.$el.querySelector("form").dispatchEvent(t),e.preventDefault()}},sync:function(e){this.content=e.target.innerHTML},send:function(e){var t=this,n=t.$el.querySelector(".textarea-content"),o={tempId:(new Date).getTime()+Math.random(),content:n.innerHTML};return o.content?(i.emit("comment",{method:"send",body:{postId:t.postId,content:t.content,tempId:o.tempId}}),e.preventDefault(),void m.insertComment(o)):void e.preventDefault()}}})});